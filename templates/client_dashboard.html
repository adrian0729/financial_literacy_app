<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Client Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Rajdhani:wght@600&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: #f8fafc;
        color: #0f172a;
        --accent: #16a34a;
        --muted: #64748b;
        --border: #e2e8f0;
        --card: #ffffff;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        background: #f8fafc;
        color: #0f172a;
      }
      header {
        position: sticky;
        top: 0;
        z-index: 10;
        background: #fff;
        border-bottom: 1px solid var(--border);
        padding: 0.85rem 1.5rem;
        display: flex;
        align-items: center;
        gap: 1rem;
      }
      .brand {
        font-family: "Rajdhani", "Inter", sans-serif;
        letter-spacing: 0.16rem;
        text-transform: uppercase;
        color: var(--accent);
        font-weight: 700;
      }
      nav {
        margin-left: auto;
        display: flex;
        gap: 0.6rem;
      }
      nav a {
        color: #0f172a;
        text-decoration: none;
        padding: 0.55rem 0.85rem;
        border-radius: 12px;
        font-weight: 600;
        border: 1px solid transparent;
      }
      nav a:hover,
      nav a.active {
        background: rgba(22, 163, 74, 0.1);
        color: #0f172a;
        border-color: rgba(22, 163, 74, 0.2);
      }
      .user-chip {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.45rem 0.75rem;
        border-radius: 12px;
        background: #f8fafc;
        border: 1px solid var(--border);
      }
      .avatar {
        width: 34px;
        height: 34px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--accent), #22c55e);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        color: #fff;
      }
      main {
        max-width: 1100px;
        margin: 0 auto;
        padding: 2rem 1.25rem 3rem;
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
      }
      .glass {
        border-radius: 18px;
        background: var(--card);
        border: 1px solid var(--border);
        box-shadow: 0 18px 45px rgba(15, 23, 42, 0.08);
        padding: 1.6rem;
      }
      .section-title {
        font-family: "Rajdhani", "Inter", sans-serif;
        letter-spacing: 0.08rem;
        text-transform: uppercase;
        font-size: 0.95rem;
        color: var(--muted);
        margin-bottom: 0.35rem;
      }
      h1,
      h2,
      h3 {
        margin: 0;
      }
      p {
        margin: 0.25rem 0 0;
        color: var(--muted);
      }
      label {
        display: block;
        margin-bottom: 0.35rem;
        font-size: 0.9rem;
        text-transform: uppercase;
        color: var(--muted);
      }
      input {
        width: 100%;
        border-radius: 14px;
        border: 1px solid var(--border);
        padding: 0.75rem 1rem;
        background: #fff;
        color: #0f172a;
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
        gap: 1rem;
      }
      button {
        border-radius: 14px;
        border: none;
        padding: 0.8rem 1.2rem;
        font-size: 0.95rem;
        cursor: pointer;
        transition: box-shadow 0.15s ease, transform 0.15s ease;
      }
      button.primary {
        background: linear-gradient(135deg, var(--accent), #22c55e);
        color: white;
      }
      button.secondary {
        background: #fff;
        color: #0f172a;
        border: 1px solid var(--border);
      }
      button:hover {
        box-shadow: 0 10px 25px rgba(15, 23, 42, 0.12);
        transform: translateY(-1px);
      }
      .status-pill {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        border-radius: 999px;
        padding: 0.25rem 0.75rem;
        font-size: 0.9rem;
      }
      .status-pill.connected {
        background: rgba(16, 185, 129, 0.2);
        color: #34d399;
      }
      .status-pill.pending {
        background: rgba(250, 204, 21, 0.2);
        color: #facc15;
      }
      .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 1rem;
      }
      .metrics-grid .item {
        background: var(--card);
        border-radius: 16px;
        padding: 1rem;
        border: 1px solid var(--border);
      }
      .pill {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.2rem 0.7rem;
        border-radius: 999px;
        font-size: 0.85rem;
        font-weight: 600;
      }
      .pill.good {
        background: rgba(16, 185, 129, 0.2);
        color: #34d399;
      }
      .pill.bad {
        background: rgba(248, 113, 113, 0.2);
        color: #f87171;
      }
      .pill.watch {
        background: rgba(251, 191, 36, 0.2);
        color: #fbbf24;
      }
      .toast-host {
        position: fixed;
        bottom: 1rem;
        right: 1rem;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        z-index: 20;
      }
      .toast {
        background: #ffffff;
        padding: 0.7rem 1rem;
        border-radius: 10px;
        border: 1px solid var(--border);
        box-shadow: 0 10px 25px rgba(15, 23, 42, 0.12);
      }
      .nav-item {
        transition: background 0.15s ease, border-color 0.15s ease;
      }
      .nav-item.active {
        background: rgba(22, 163, 74, 0.1);
        border-color: rgba(22, 163, 74, 0.2);
      }
    </style>
  </head>
  <body>
    {% set path = request.url.path %}
    {% if active_section %}
      {% set current = active_section %}
    {% elif path.startswith('/app/metrics') %}
      {% set current = 'metrics' %}
    {% elif path.startswith('/app/account') %}
      {% set current = 'account' %}
    {% else %}
      {% set current = 'overview' %}
    {% endif %}
    <header>
      <div class="brand">{{ client.name if client else "Client portal" }}</div>
      <nav>
        <a href="/app/overview" class="nav-item {% if current == 'overview' %}active{% endif %}">Overview</a>
        <a href="/app/metrics" class="nav-item {% if current == 'metrics' %}active{% endif %}">Metrics</a>
        <a href="/app/account" class="nav-item {% if current == 'account' %}active{% endif %}">Account</a>
      </nav>
      <div class="user-chip">
        <div class="avatar">{{ user.email[:2].upper() }}</div>
        <div style="font-size:0.95rem">{{ user.email }}</div>
        <form method="post" action="/logout">
          <button class="secondary" type="submit" style="margin-left:0.5rem">Logout</button>
        </form>
      </div>
    </header>
{% if not client %}
    <main>
      <div class="glass">
        <h2>No client profile</h2>
        <p>Please contact your advisor so they can assign a company to your login.</p>
      </div>
    </main>
{% else %}
    <main>
      {% if current == 'overview' %}
      <section class="glass" id="overview">
        <div class="section-title">Welcome</div>
        <h1>Welcome, {{ (client_profile.contact_name.split(' ')[0] if client_profile and client_profile.contact_name else client.name.split(' ')[0]) }}</h1>
        <div class="status-pill {{ 'connected' if client.connected else 'pending' }}" style="margin-top:0.5rem">
          {% if client.connected %}Connected to QuickBooks{% else %}Not connected{% endif %}
        </div>
        <p style="margin-top:0.75rem">
          This portal gives you a clean snapshot of your company’s liquidity and leverage. Connect QuickBooks to pull live balance sheet data, refresh your metrics anytime, track recent activity, and keep your contact details up to date.
        </p>
      </section>
      {% endif %}

      {% if current == 'metrics' %}
      <section class="glass" id="connect">
        <div class="section-title">Connection</div>
        <h2>QuickBooks link</h2>
        <p>Connect your company to sync balance sheet data for real-time metrics.</p>
        <div class="button-row" style="margin-top:1rem; display:flex; gap:0.6rem; flex-wrap:wrap">
          <button class="primary" onclick="beginOAuth()">Connect QuickBooks</button>
          <button class="secondary" onclick="fetchMetrics()">Refresh metrics</button>
          <button class="secondary" onclick="disconnectClient()">Disconnect</button>
        </div>
        <div id="status" style="margin-top:1rem;font-size:0.95rem;color:var(--muted)"></div>
      </section>

      <section class="glass" id="metrics">
        <div class="section-title">Financial metrics</div>
        <h2>At-a-glance ratios</h2>
        <div class="metrics-grid" style="margin-top:1rem">
          <div class="item">
            <div style="display:flex; justify-content:space-between; align-items:center">
              <span>Working Capital</span>
              <span class="pill good" id="chip-workingCapital">Healthy</span>
            </div>
            <strong id="workingCapital">—</strong>
          </div>
          <div class="item">
            <div style="display:flex; justify-content:space-between; align-items:center">
              <span>Working Capital Ratio</span>
              <span class="pill watch" id="chip-workingCapitalRatio">Watch</span>
            </div>
            <strong id="workingCapitalRatio">—</strong>
          </div>
          <div class="item">
            <div style="display:flex; justify-content:space-between; align-items:center">
              <span>Debt-to-Equity Ratio</span>
              <span class="pill watch" id="chip-debtToEquityRatio">Watch</span>
            </div>
            <strong id="debtToEquityRatio">—</strong>
          </div>
          <div class="item">
            <div style="display:flex; justify-content:space-between; align-items:center">
              <span>Current Assets</span>
              <span class="pill good" id="chip-currentAssets">Healthy</span>
            </div>
            <strong id="currentAssets">—</strong>
          </div>
          <div class="item">
            <div style="display:flex; justify-content:space-between; align-items:center">
              <span>Current Liabilities</span>
              <span class="pill bad" id="chip-currentLiabilities">Action</span>
            </div>
            <strong id="currentLiabilities">—</strong>
          </div>
          <div class="item">
            <div style="display:flex; justify-content:space-between; align-items:center">
              <span>Total Liabilities</span>
              <span class="pill bad" id="chip-totalLiabilities">Action</span>
            </div>
            <strong id="totalLiabilities">—</strong>
          </div>
          <div class="item">
            <div style="display:flex; justify-content:space-between; align-items:center">
              <span>Total Equity</span>
              <span class="pill good" id="chip-totalEquity">Healthy</span>
            </div>
            <strong id="totalEquity">—</strong>
          </div>
        </div>
      </section>
      {% endif %}

      {% if current == 'account' %}
      <section class="glass" id="account">
        <div class="section-title">Company profile</div>
        <h2>Update your details</h2>
        <form method="post" action="/client/profile" class="grid" style="margin-top:1rem; grid-template-columns: repeat(auto-fit, minmax(230px, 1fr)); gap:1rem">
          <div>
            <label for="contact_name">Primary contact</label>
            <input id="contact_name" name="contact_name" value="{{ client_profile.contact_name if client_profile else '' }}" />
          </div>
          <div>
            <label for="phone">Phone</label>
            <input id="phone" name="phone" value="{{ client_profile.phone if client_profile else '' }}" />
          </div>
          <div>
            <label for="industry">Industry</label>
            <input id="industry" name="industry" value="{{ client_profile.industry if client_profile else client.industry or '' }}" placeholder="e.g., SaaS, eCommerce, Services" />
          </div>
          <div>
            <label for="employees">Team size</label>
            {% set emp = client_profile.employees if client_profile else '' %}
            <select id="employees" name="employees">
              {% for option in ['1-4','5-20','21-50','51-100','101-500','500+'] %}
              <option value="{{ option }}" {% if emp == option %}selected{% endif %}>{{ option }}</option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label for="revenue">Monthly revenue</label>
            {% set rev = client_profile.revenue if client_profile else '' %}
            <select id="revenue" name="revenue">
              {% for option in ['< $50k','$50k - $100k','$100k - $250k','$250k - $500k','$500k - $1M','$1M+'] %}
              <option value="{{ option }}" {% if rev == option %}selected{% endif %}>{{ option }}</option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label>E-commerce?</label>
            {% set eco = client_profile.ecommerce if client_profile else None %}
            <div class="radio-row" style="gap:0.75rem">
              <label><input type="radio" name="ecommerce" value="yes" {% if eco == 1 %}checked{% endif %}/> Yes</label>
              <label><input type="radio" name="ecommerce" value="no" {% if eco == 0 %}checked{% endif %}/> No</label>
            </div>
          </div>
          <div style="grid-column:1/-1">
            <label>Funding sources</label>
            {% set funding_set = (client_profile.funding.split(',')|map('trim')|list if client_profile and client_profile.funding else []) %}
            <div class="checkbox-group" style="gap:0.4rem">
              {% for option in ['Angel/Seed','VC/Growth','Revenue funded','Debt/Loan','Bootstrapped'] %}
              <label><input type="checkbox" name="funding" value="{{ option }}" {% if option in funding_set %}checked{% endif %}/> {{ option }}</label>
              {% endfor %}
            </div>
          </div>
          <div>
            <label for="intent">Primary goal</label>
            {% set intent_val = client_profile.intent if client_profile else '' %}
            <select id="intent" name="intent">
              {% for option in ['Cash visibility','Board reporting','Fundraising prep','Lender package','Tax prep','Other'] %}
              <option value="{{ option }}" {% if intent_val == option %}selected{% endif %}>{{ option }}</option>
              {% endfor %}
            </select>
          </div>
          <div style="grid-column:1/-1">
            <label for="intent_extra">Notes / context</label>
            <textarea id="intent_extra" name="intent_extra" placeholder="Key tools, banks, pain points" style="min-height:90px">{{ client_profile.intent_extra if client_profile else '' }}</textarea>
          </div>
          <div>
            <label for="address_line">Address</label>
            <input id="address_line" name="address_line" value="{{ client_profile.address_line if client_profile else '' }}" />
          </div>
          <div>
            <label for="city">City</label>
            <input id="city" name="city" value="{{ client_profile.city if client_profile else '' }}" />
          </div>
          <div>
            <label for="state">State/Province</label>
            <input id="state" name="state" value="{{ client_profile.state if client_profile else '' }}" />
          </div>
          <div>
            <label for="postal_code">Postal code</label>
            <input id="postal_code" name="postal_code" value="{{ client_profile.postal_code if client_profile else '' }}" />
          </div>
          <div style="grid-column:1/-1; display:flex; gap:0.6rem; align-items:center; flex-wrap:wrap">
            <button type="submit" class="primary">Save profile</button>
            <span style="color:var(--muted); font-size:0.95rem">You can update any onboarding details here.</span>
          </div>
        </form>
      </section>
      {% endif %}

    </main>
{% endif %}
    <div class="toast-host" id="toastHost"></div>
    <script>
      const clientKey = "{{ client.client_key if client else '' }}";
      const formatter = new Intl.NumberFormat(undefined, { style: "currency", currency: "USD", maximumFractionDigits: 0 });
      const ratioFormatter = new Intl.NumberFormat(undefined, { style: "decimal", minimumFractionDigits: 2, maximumFractionDigits: 2 });

      function showToast(message, tone = "neutral") {
        const host = document.getElementById("toastHost");
        const toast = document.createElement("div");
        toast.className = "toast";
        toast.textContent = message;
        if (tone === "error") {
          toast.style.borderColor = "rgba(248, 113, 113, 0.4)";
        } else if (tone === "success") {
          toast.style.borderColor = "rgba(16, 185, 129, 0.3)";
        }
        host.appendChild(toast);
        setTimeout(() => toast.remove(), 4000);
      }

      function beginOAuth() {
        if (!clientKey) {
          showToast("Client not found.", "error");
          return;
        }
        window.location.href = `/auth?client_key=${encodeURIComponent(clientKey)}`;
      }

      async function fetchMetrics() {
        if (!clientKey) {
          showToast("Client not found.", "error");
          return;
        }
        try {
          const response = await fetch(`/metrics?client_key=${encodeURIComponent(clientKey)}`);
          const body = await response.json();
          if (!response.ok) throw new Error(body.detail || response.statusText);
          updateMetric("workingCapital", body.workingCapital);
          updateMetric("workingCapitalRatio", body.workingCapitalRatio, true);
          updateMetric("debtToEquityRatio", body.debtToEquityRatio, true);
          updateMetric("currentAssets", body.currentAssets);
          updateMetric("currentLiabilities", body.currentLiabilities);
          updateMetric("totalLiabilities", body.totalLiabilities);
          updateMetric("totalEquity", body.totalEquity);
          showToast("Metrics refreshed.", "success");
        } catch (error) {
          showToast(error.message, "error");
        }
      }

      async function disconnectClient() {
        try {
          const response = await fetch(`/disconnect?client_key=${encodeURIComponent(clientKey)}`, { method: "POST" });
          const body = await response.json();
          if (!response.ok) throw new Error(body.detail || response.statusText);
          showToast("Disconnected from QuickBooks.", "success");
        } catch (error) {
          showToast(error.message, "error");
        }
      }

      function updateMetric(id, value, isRatio = false) {
        const el = document.getElementById(id);
        const chip = document.getElementById(`chip-${id}`);
        if (!el) return;
        if (value == null) {
          el.textContent = "—";
          if (chip) {
            chip.textContent = "No data";
            chip.className = "pill watch";
          }
          return;
        }
        el.textContent = isRatio ? ratioFormatter.format(value) : formatter.format(value);
        if (chip) {
          let status = "watch";
          if (id === "workingCapitalRatio") {
            if (value >= 1.2) status = "good";
            else if (value < 1) status = "bad";
          } else if (id === "debtToEquityRatio") {
            if (value <= 1.5) status = "good";
            else if (value > 3) status = "bad";
          } else if (id === "currentLiabilities" || id === "totalLiabilities") {
            status = "bad";
          } else {
            status = "good";
          }
          chip.className = `pill ${status}`;
          chip.textContent = status === "good" ? "Healthy" : status === "bad" ? "Action" : "Watch";
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        if (clientKey && {{ 'true' if client.connected else 'false' }}) {
          fetchMetrics();
        }
        document.querySelector("nav a")?.classList.add("active");
      });
    </script>
  </body>
</html>
