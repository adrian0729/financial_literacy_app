<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Client Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Rajdhani:wght@600&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: #050910;
        color: #e2e8f0;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        background: radial-gradient(circle at 15% 20%, rgba(59, 130, 246, 0.3), transparent 45%),
          radial-gradient(circle at 80% 0%, rgba(14, 165, 233, 0.35), transparent 45%),
          #050910;
      }
      header {
        position: sticky;
        top: 0;
        z-index: 10;
        backdrop-filter: blur(12px);
        background: rgba(5, 9, 16, 0.8);
        border-bottom: 1px solid rgba(148, 163, 184, 0.2);
        padding: 0.85rem 1.5rem;
        display: flex;
        align-items: center;
        gap: 1rem;
      }
      .brand {
        font-family: "Rajdhani", "Inter", sans-serif;
        letter-spacing: 0.16rem;
        text-transform: uppercase;
        color: #60a5fa;
        font-weight: 700;
      }
      nav {
        margin-left: auto;
        display: flex;
        gap: 0.9rem;
      }
      nav a {
        color: #cbd5f5;
        text-decoration: none;
        padding: 0.55rem 0.85rem;
        border-radius: 12px;
        font-weight: 600;
      }
      nav a:hover,
      nav a.active {
        background: rgba(96, 165, 250, 0.15);
        color: #fff;
      }
      .user-chip {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.45rem 0.75rem;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(148, 163, 184, 0.15);
      }
      .avatar {
        width: 34px;
        height: 34px;
        border-radius: 50%;
        background: linear-gradient(135deg, #2563eb, #14b8a6);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
      }
      main {
        max-width: 1100px;
        margin: 0 auto;
        padding: 2rem 1.25rem 3rem;
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
      }
      .glass {
        border-radius: 22px;
        background: rgba(12, 18, 32, 0.7);
        border: 1px solid rgba(148, 163, 184, 0.18);
        box-shadow: 0 25px 60px rgba(2, 6, 23, 0.7);
        backdrop-filter: blur(16px);
        padding: 1.6rem;
      }
      .section-title {
        font-family: "Rajdhani", "Inter", sans-serif;
        letter-spacing: 0.08rem;
        text-transform: uppercase;
        font-size: 0.95rem;
        color: #94a3b8;
        margin-bottom: 0.35rem;
      }
      h1,
      h2,
      h3 {
        margin: 0;
      }
      p {
        margin: 0.25rem 0 0;
        color: #94a3b8;
      }
      label {
        display: block;
        margin-bottom: 0.35rem;
        font-size: 0.9rem;
        text-transform: uppercase;
        color: #94a3b8;
      }
      input {
        width: 100%;
        border-radius: 14px;
        border: 1px solid rgba(148, 163, 184, 0.35);
        padding: 0.75rem 1rem;
        background: rgba(5, 8, 16, 0.7);
        color: #f8fafc;
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
        gap: 1rem;
      }
      button {
        border-radius: 14px;
        border: none;
        padding: 0.8rem 1.2rem;
        font-size: 0.95rem;
        cursor: pointer;
      }
      button.primary {
        background: linear-gradient(135deg, #2563eb, #14b8a6);
        color: white;
      }
      button.secondary {
        background: rgba(255, 255, 255, 0.08);
        color: #e2e8f0;
        border: 1px solid rgba(148, 163, 184, 0.25);
      }
      .status-pill {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        border-radius: 999px;
        padding: 0.25rem 0.75rem;
        font-size: 0.9rem;
      }
      .status-pill.connected {
        background: rgba(16, 185, 129, 0.2);
        color: #34d399;
      }
      .status-pill.pending {
        background: rgba(250, 204, 21, 0.2);
        color: #facc15;
      }
      .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 1rem;
      }
      .metrics-grid .item {
        background: rgba(15, 23, 42, 0.75);
        border-radius: 16px;
        padding: 1rem;
        border: 1px solid rgba(148, 163, 184, 0.2);
      }
      .pill {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.2rem 0.7rem;
        border-radius: 999px;
        font-size: 0.85rem;
        font-weight: 600;
      }
      .pill.good {
        background: rgba(16, 185, 129, 0.2);
        color: #34d399;
      }
      .pill.bad {
        background: rgba(248, 113, 113, 0.2);
        color: #f87171;
      }
      .pill.watch {
        background: rgba(251, 191, 36, 0.2);
        color: #fbbf24;
      }
      .toast-host {
        position: fixed;
        top: 1rem;
        right: 1rem;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        z-index: 20;
      }
      .toast {
        background: rgba(15, 23, 42, 0.9);
        padding: 0.7rem 1rem;
        border-radius: 10px;
        border: 1px solid rgba(148, 163, 184, 0.3);
      }
    </style>
  </head>
  <body>
    <header>
      <div class="brand">{{ client.name if client else "Client portal" }}</div>
      <nav>
        <a href="#overview" data-target="overview">Overview</a>
        <a href="#connect" data-target="connect">Connection</a>
        <a href="#metrics" data-target="metrics">Metrics</a>
        <a href="#account" data-target="account">Account</a>
      </nav>
      <div class="user-chip">
        <div class="avatar">{{ user.email[:2].upper() }}</div>
        <div style="font-size:0.95rem">{{ user.email }}</div>
        <form method="post" action="/logout">
          <button class="secondary" type="submit" style="margin-left:0.5rem">Logout</button>
        </form>
      </div>
    </header>
    {% if not client %}
    <main>
      <div class="glass">
        <h2>No client profile</h2>
        <p>Please contact your advisor so they can assign a company to your login.</p>
      </div>
    </main>
    {% else %}
    <main>
      <section class="glass" id="overview">
        <div class="section-title">Welcome</div>
        <h1>{{ client.name }}</h1>
        <div class="status-pill {{ 'connected' if client.connected else 'pending' }}" style="margin-top:0.5rem">
          {% if client.connected %}Connected to QuickBooks{% else %}Not connected{% endif %}
        </div>
        <p style="margin-top:0.75rem">Connect to keep your financial health metrics current.</p>
      </section>

      <section class="glass" id="connect">
        <div class="section-title">Connection</div>
        <h2>QuickBooks link</h2>
        <p>Connect your company to sync balance sheet data for real-time metrics.</p>
        <div class="button-row" style="margin-top:1rem; display:flex; gap:0.6rem; flex-wrap:wrap">
          <button class="primary" onclick="beginOAuth()">Connect QuickBooks</button>
          <button class="secondary" onclick="fetchMetrics()">Refresh metrics</button>
          <button class="secondary" onclick="disconnectClient()">Disconnect</button>
        </div>
        <div id="status" style="margin-top:1rem;font-size:0.95rem;color:#94a3b8"></div>
      </section>

      <section class="glass" id="metrics">
        <div class="section-title">Financial metrics</div>
        <h2>At-a-glance ratios</h2>
        <div class="metrics-grid" style="margin-top:1rem">
          <div class="item">
            <div style="display:flex; justify-content:space-between; align-items:center">
              <span>Working Capital</span>
              <span class="pill good" id="chip-workingCapital">Healthy</span>
            </div>
            <strong id="workingCapital">—</strong>
          </div>
          <div class="item">
            <div style="display:flex; justify-content:space-between; align-items:center">
              <span>Working Capital Ratio</span>
              <span class="pill watch" id="chip-workingCapitalRatio">Watch</span>
            </div>
            <strong id="workingCapitalRatio">—</strong>
          </div>
          <div class="item">
            <div style="display:flex; justify-content:space-between; align-items:center">
              <span>Debt-to-Equity Ratio</span>
              <span class="pill watch" id="chip-debtToEquityRatio">Watch</span>
            </div>
            <strong id="debtToEquityRatio">—</strong>
          </div>
          <div class="item">
            <div style="display:flex; justify-content:space-between; align-items:center">
              <span>Current Assets</span>
              <span class="pill good" id="chip-currentAssets">Healthy</span>
            </div>
            <strong id="currentAssets">—</strong>
          </div>
          <div class="item">
            <div style="display:flex; justify-content:space-between; align-items:center">
              <span>Current Liabilities</span>
              <span class="pill bad" id="chip-currentLiabilities">Action</span>
            </div>
            <strong id="currentLiabilities">—</strong>
          </div>
          <div class="item">
            <div style="display:flex; justify-content:space-between; align-items:center">
              <span>Total Liabilities</span>
              <span class="pill bad" id="chip-totalLiabilities">Action</span>
            </div>
            <strong id="totalLiabilities">—</strong>
          </div>
          <div class="item">
            <div style="display:flex; justify-content:space-between; align-items:center">
              <span>Total Equity</span>
              <span class="pill good" id="chip-totalEquity">Healthy</span>
            </div>
            <strong id="totalEquity">—</strong>
          </div>
        </div>
      </section>

      <section class="glass" id="account">
        <div class="section-title">Company profile</div>
        <h2>Update contact details</h2>
        <form method="post" action="/client/profile" class="grid" style="margin-top:1rem">
          <div>
            <label for="contact_name">Primary contact</label>
            <input id="contact_name" name="contact_name" value="{{ client_profile.contact_name if client_profile else '' }}" />
          </div>
          <div>
            <label for="phone">Phone</label>
            <input id="phone" name="phone" value="{{ client_profile.phone if client_profile else '' }}" />
          </div>
          <div>
            <label for="industry">Industry</label>
            <input id="industry" name="industry" value="{{ client_profile.industry if client_profile else client.industry or '' }}" />
          </div>
          <div>
            <label for="address_line">Address</label>
            <input id="address_line" name="address_line" value="{{ client_profile.address_line if client_profile else '' }}" />
          </div>
          <div>
            <label for="city">City</label>
            <input id="city" name="city" value="{{ client_profile.city if client_profile else '' }}" />
          </div>
          <div>
            <label for="state">State</label>
            <input id="state" name="state" value="{{ client_profile.state if client_profile else '' }}" />
          </div>
          <div>
            <label for="postal_code">Postal code</label>
            <input id="postal_code" name="postal_code" value="{{ client_profile.postal_code if client_profile else '' }}" />
          </div>
          <div style="grid-column:1/-1; display:flex; gap:0.6rem; align-items:center">
            <button type="submit" class="primary">Save profile</button>
            <span style="color:#94a3b8; font-size:0.95rem">You can update this anytime.</span>
          </div>
        </form>
      </section>
    </main>
    <div class="toast-host" id="toastHost"></div>
    <script>
      const clientKey = "{{ client.client_key if client else '' }}";
      const formatter = new Intl.NumberFormat(undefined, { style: "currency", currency: "USD", maximumFractionDigits: 0 });
      const ratioFormatter = new Intl.NumberFormat(undefined, { style: "decimal", minimumFractionDigits: 2, maximumFractionDigits: 2 });

      function showToast(message, tone = "neutral") {
        const host = document.getElementById("toastHost");
        const toast = document.createElement("div");
        toast.className = "toast";
        toast.textContent = message;
        if (tone === "error") {
          toast.style.borderColor = "rgba(248, 113, 113, 0.4)";
        } else if (tone === "success") {
          toast.style.borderColor = "rgba(16, 185, 129, 0.3)";
        }
        host.appendChild(toast);
        setTimeout(() => toast.remove(), 4000);
      }

      function beginOAuth() {
        if (!clientKey) {
          showToast("Client not found.", "error");
          return;
        }
        window.location.href = `/auth?client_key=${encodeURIComponent(clientKey)}`;
      }

      async function fetchMetrics() {
        if (!clientKey) {
          showToast("Client not found.", "error");
          return;
        }
        try {
          const response = await fetch(`/metrics?client_key=${encodeURIComponent(clientKey)}`);
          const body = await response.json();
          if (!response.ok) throw new Error(body.detail || response.statusText);
          updateMetric("workingCapital", body.workingCapital);
          updateMetric("workingCapitalRatio", body.workingCapitalRatio, true);
          updateMetric("debtToEquityRatio", body.debtToEquityRatio, true);
          updateMetric("currentAssets", body.currentAssets);
          updateMetric("currentLiabilities", body.currentLiabilities);
          updateMetric("totalLiabilities", body.totalLiabilities);
          updateMetric("totalEquity", body.totalEquity);
          showToast("Metrics refreshed.", "success");
        } catch (error) {
          showToast(error.message, "error");
        }
      }

      async function disconnectClient() {
        try {
          const response = await fetch(`/disconnect?client_key=${encodeURIComponent(clientKey)}`, { method: "POST" });
          const body = await response.json();
          if (!response.ok) throw new Error(body.detail || response.statusText);
          showToast("Disconnected from QuickBooks.", "success");
        } catch (error) {
          showToast(error.message, "error");
        }
      }

      function updateMetric(id, value, isRatio = false) {
        const el = document.getElementById(id);
        const chip = document.getElementById(`chip-${id}`);
        if (!el) return;
        if (value == null) {
          el.textContent = "—";
          if (chip) {
            chip.textContent = "No data";
            chip.className = "pill watch";
          }
          return;
        }
        el.textContent = isRatio ? ratioFormatter.format(value) : formatter.format(value);
        if (chip) {
          let status = "watch";
          if (id === "workingCapitalRatio") {
            if (value >= 1.2) status = "good";
            else if (value < 1) status = "bad";
          } else if (id === "debtToEquityRatio") {
            if (value <= 1.5) status = "good";
            else if (value > 3) status = "bad";
          } else if (id === "currentLiabilities" || id === "totalLiabilities") {
            status = "bad";
          } else {
            status = "good";
          }
          chip.className = `pill ${status}`;
          chip.textContent = status === "good" ? "Healthy" : status === "bad" ? "Action" : "Watch";
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        if (clientKey && {{ 'true' if client.connected else 'false' }}) {
          fetchMetrics();
        }
        document.querySelector("nav a")?.classList.add("active");
        document.querySelectorAll("nav a").forEach((link) => {
          link.addEventListener("click", (e) => {
            e.preventDefault();
            const targetId = link.dataset.target;
            const target = document.getElementById(targetId);
            if (target) target.scrollIntoView({ behavior: "smooth" });
            document.querySelectorAll("nav a").forEach((ln) => ln.classList.remove("active"));
            link.classList.add("active");
          });
        });
      });
    </script>
    {% endif %}
  </body>
</html>
